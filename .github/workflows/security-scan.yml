name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for sensitive files
      run: |
        echo "ðŸ” Scanning for sensitive files..."
        
        # Check for .env files
        if find . -name ".env*" -not -name ".env.example" | grep -q .; then
          echo "âŒ Found .env files that should not be committed:"
          find . -name ".env*" -not -name ".env.example"
          exit 1
        fi
        
        # Check for backup files
        if find . -name "*.backup" | grep -q .; then
          echo "âŒ Found backup files that should not be committed:"
          find . -name "*.backup"
          exit 1
        fi
        
        # Check for common secret patterns
        if grep -r "sk_live_" . --exclude-dir=node_modules --exclude-dir=.git; then
          echo "âŒ Found potential live Stripe keys"
          exit 1
        fi
        
        if grep -r "pk_live_" . --exclude-dir=node_modules --exclude-dir=.git; then
          echo "âŒ Found potential live Stripe keys"
          exit 1
        fi
        
        # Check for hardcoded passwords
        if grep -r "password.*=.*['\"][^'\"]*['\"]" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.md"; then
          echo "âŒ Found potential hardcoded passwords"
          exit 1
        fi
        
        echo "âœ… No sensitive files found"
        
    - name: Run npm audit
      working-directory: ./apps/web
      run: |
        echo "ðŸ”’ Running security audit..."
        npm audit --audit-level=moderate
        
    - name: Check for console.log statements
      run: |
        echo "ðŸ“ Checking for console.log statements in production code..."
        
        # Count console.log statements in TypeScript/JavaScript files
        CONSOLE_COUNT=$(grep -r "console\.log" . --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.test.*" --exclude="*.spec.*" | wc -l)
        
        if [ "$CONSOLE_COUNT" -gt 0 ]; then
          echo "âš ï¸  Found $CONSOLE_COUNT console.log statements in production code:"
          grep -r "console\.log" . --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.test.*" --exclude="*.spec.*"
          echo "ðŸ’¡ Consider removing or replacing with proper logging"
        else
          echo "âœ… No console.log statements found in production code"
        fi
        
    - name: Check for 'any' types
      run: |
        echo "ðŸ” Checking for 'any' types in TypeScript code..."
        
        # Count 'any' type usage
        ANY_COUNT=$(grep -r ": any" . --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.test.*" --exclude="*.spec.*" | wc -l)
        
        if [ "$ANY_COUNT" -gt 0 ]; then
          echo "âš ï¸  Found $ANY_COUNT 'any' type usages:"
          grep -r ": any" . --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.test.*" --exclude="*.spec.*"
          echo "ðŸ’¡ Consider using 'unknown' with proper type guards"
        else
          echo "âœ… No 'any' types found"
        fi
        
    - name: Check file sizes
      run: |
        echo "ðŸ“ Checking for large files..."
        
        # Find files larger than 1MB
        LARGE_FILES=$(find . -type f -size +1M -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./.next/*" -not -path "./dist/*" -not -path "./build/*")
        
        if [ -n "$LARGE_FILES" ]; then
          echo "âš ï¸  Found large files (>1MB):"
          echo "$LARGE_FILES"
          echo "ðŸ’¡ Consider optimizing or adding to .gitignore"
        else
          echo "âœ… No unusually large files found"
        fi
        
    - name: Security scan summary
      run: |
        echo "ðŸŽ¯ Security scan completed successfully!"
        echo "âœ… No sensitive files committed"
        echo "âœ… Security audit passed"
        echo "âœ… Code quality checks completed"
